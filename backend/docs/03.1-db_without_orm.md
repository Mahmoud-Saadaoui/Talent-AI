# ðŸ—„ï¸ Base de donnÃ©es

Configuration et utilisation de PostgreSQL.

## Vue d'ensemble

- **SGBD** : PostgreSQL 14+
- **Client** : `pg` (node-postgres)
- **Connection** : Pool de connexions
- **Scripts SQL** : `src/config/`

---

## Configuration

### Variables d'environnement (`.env`)

```env
DB_USER=postgres
DB_HOST=localhost
DB_NAME=talent_ai_db
DB_PASSWORD=votre_mot_de_passe
DB_PORT=5432
```

### Pool de connexions (`src/config/db.ts`)

```typescript
import pg from 'pg';

const pool = new pg.Pool({
  user: process.env.DB_USER,
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT,
});

export default pool;
```

---

## Scripts SQL

### 1. `initDb.sql` - CrÃ©ation de la base

CrÃ©e la base de donnÃ©es `talent_ai_db`.

**Utilisation :**
```bash
npm run db:init
```

**Contenu :**
```sql
CREATE DATABASE talent_ai_db
    WITH OWNER = postgres
    ENCODING = 'UTF8';
```

### 2. `schema.sql` - CrÃ©ation des tables

CrÃ©e toutes les tables de l'application.

**Utilisation :**
```bash
npm run db:schema
```

**Contenu actuel :**
```sql
-- Table users
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

---

## Tables existantes

### `users`

| Colonne | Type | Contraintes |
|---------|------|-------------|
| `id` | SERIAL | PRIMARY KEY |
| `nom` | VARCHAR(100) | NOT NULL |
| `email` | VARCHAR(255) | NOT NULL, UNIQUE |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() |
| `updated_at` | TIMESTAMPTZ | DEFAULT NOW() |

**Index :**
- `idx_users_email` sur la colonne `email`

**Trigger :**
- `update_users_updated_at` : Met Ã  jour `updated_at` automatiquement

---

## Utiliser la base dans le code

### Exemple : RequÃªte simple

```typescript
import pool from '../config/db.js';

// RÃ©cupÃ©rer tous les utilisateurs
async function getAllUsers() {
  const result = await pool.query('SELECT * FROM users ORDER BY id');
  return result.rows;
}

// RÃ©cupÃ©rer un utilisateur par ID
async function getUserById(id: number) {
  const result = await pool.query(
    'SELECT * FROM users WHERE id = $1',
    [id]
  );
  return result.rows[0];
}

// CrÃ©er un utilisateur
async function createUser(nom: string, email: string) {
  const result = await pool.query(
    'INSERT INTO users (nom, email) VALUES ($1, $2) RETURNING *',
    [nom, email]
  );
  return result.rows[0];
}

// Supprimer un utilisateur
async function deleteUser(id: number) {
  await pool.query('DELETE FROM users WHERE id = $1', [id]);
}
```

### Exemple avec paramÃ¨tres de requÃªte

```typescript
// Recherche par email
async function findByEmail(email: string) {
  const result = await pool.query(
    'SELECT * FROM users WHERE email = $1',
    [email]
  );
  return result.rows[0];
}
```

---

## Bonnes pratiques

### âœ… Ã€ faire

- Utiliser les **paramÃ¨tres** (`$1`, `$2`) pour Ã©viter les injections SQL
- Utiliser `RETURNING *` pour rÃ©cupÃ©rer les donnÃ©es insÃ©rÃ©es
- GÃ©rer les erreurs de base de donnÃ©es
- Fermer le pool proprement Ã  l'arrÃªt

### âŒ Ã€ Ã©viter

- ConcatÃ©ner les requÃªtes SQL
- Oublier de vÃ©rifier les rÃ©sultats
- Ignorer les contraintes d'unicitÃ©

---

## Commandes utiles

### Via script npm

```bash
npm run db:init    # CrÃ©er la base
npm run db:schema  # CrÃ©er les tables
npm run db:reset   # Reset complet
```

### Via psql (ligne de commande)

```bash
# Se connecter Ã  la base
psql -U postgres -d talent_ai_db

# Lister les tables
\dt

# DÃ©crire une table
\d users

# Quitter
\q
```

---

## Sauvegarde et restauration

### Sauvegarder

```bash
pg_dump -U postgres talent_ai_db > backup.sql
```

### Restaurer

```bash
psql -U postgres -d talent_ai_db < backup.sql
```

---

**Prochaine Ã©tape : [API Endpoints](./04-api.md)**
